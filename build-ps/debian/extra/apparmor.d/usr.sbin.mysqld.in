#include <tunables/global>

/usr/sbin/mysqld flags=(attach_disconnected complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/user-tmp>
  #include <abstractions/mysql>
  #include <abstractions/winbind>

# Allow system resource access
  /sys/devices/system/cpu/ r,
  /sys/devices/system/node/ r,
  /sys/devices/system/node/** r,
  /proc/*/status r,
  capability sys_resource,
  capability dac_override,
  capability setuid,
  capability setgid,
  capability sys_nice,

# Allow network access
  network tcp,

  /etc/hosts.allow r,
  /etc/hosts.deny r,

# Allow config access
  /etc/mysql/** r,

# Allow pid, socket, socket lock file access
  /var/run/mysqld/mysqld.pid rw,
  /var/run/mysqld/mysqld.sock rw,
  /var/run/mysqld/mysqld.sock.lock rw,
  /var/run/mysqld/mysqlx.sock rw,
  /var/run/mysqld/mysqlx.sock.lock rw,
  /run/mysqld/mysqld.pid rw,
  /run/mysqld/mysqld.sock rw,
  /run/mysqld/mysqld.sock.lock rw,
  /run/mysqld/mysqlx.sock rw,
  /run/mysqld/mysqlx.sock.lock rw,

# Allow systemd notify messages
  /{,var/}run/systemd/notify w,

# Allow execution of server binary
  /usr/sbin/mysqld mr,
  /usr/sbin/mysqld-debug mr,

# Allow plugin access
  /usr/lib/mysql/plugin/ r,
  /usr/lib/mysql/plugin/*.so* mr,

# Allow error msg and charset access
  /usr/share/mysql/ r,
  /usr/share/mysql/** r,
  /usr/share/mysql-@MYSQL_BASE_VERSION@/ r,
  /usr/share/mysql-@MYSQL_BASE_VERSION@/** r,

# Allow data dir access
  /var/lib/mysql/ r,
  /var/lib/mysql/** rwk,

# Allow data files dir access
  /var/lib/mysql-files/ r,
  /var/lib/mysql-files/** rwk,

# Allow keyring dir access
  /var/lib/mysql-keyring/ r,
  /var/lib/mysql-keyring/** rwk,

# Allow log file access
  /var/log/mysql/ r,
  /var/log/mysql/** rw,

# Allow access to openssl config
  /etc/ssl/openssl.cnf r,

################################################################################
# Percona XtraDB Cluster specific

  # wsrep_sst script
  # It would be easier to grant access to /usr/bin/** ixrw, but that will cause
  # hardening to be weaker.

  # By default Ubuntu uses Dash
  /bin/dash ix,
  /bin/bash ix,
  /bin/sh ix,
  /bin/grep ix,
  /bin/rm ixr,
  /bin/mktemp ixr,
  /bin/ps ixr,
  /bin/sleep ix,
  /bin/ls ix,
  /bin/cat ixr,
  /bin/mkdir ixr,

  /{,usr/}bin/wsrep* ixrw,
  /{,usr/}bin/dirname ix,
  /{,usr/}bin/cut ix,
  /{,usr/}bin/which ixr,

  /{,usr/}bin/gawk ix,
  /{,usr/}bin/awk ix,
  /{,usr/}bin/my_print_defaults ix,
  /{,usr/}bin/tail ix, 
  /{,usr/}bin/head ix,
  /{,usr/}bin/tr ix,
  /{,usr/}bin/touch ix,
  /{,usr/}bin/id ix,
  /{,usr/}bin/timeout ix,
  /{,usr/}bin/socat ix,
  /{,usr/}bin/expr ixr,
  /{,usr/}bin/fold ixr,
  /{,usr/}bin/basename ixr,
  /{,usr/}bin/perl ix,
  /{,usr/}bin/find ixr,
  /{,usr/}bin/mysqladmin ixr,
  /{,usr/}bin/mysql ixr,
  /{,usr/}bin/openssl ixr,
  /{,usr/}bin/diff ixr,
  /{,usr/}bin/pxc_extra/** ixr,

  /{,usr/}sbin/mysqld ix,

  /dev/tty wr,

  # It would be easier to grant access to /proc/** ixrw, but that will cause
  # hardening to be weaker.

  /proc/*/net/tcp r,
  /proc/*/net/tcp6 r,
  /proc/sys/vm/min/_free_kbytes r,
  /proc/*/exe r,
  /proc/*/cmdline r,
  /proc/cpuinfo r,
  /proc/*/fd/ ixr,
  /proc/*/fd/** ixr,
  /proc/*/stat r,
  /proc/sys/kernel/osrelease r,  

  # Needed only by debug builds?
#  /proc/sys/kernel/pid_max r,  
#  /proc/ r,
#  /proc/uptime r,
#  /usr/share/perl/** r,

#  ptrace (trace) peer=/usr/sbin/mysqld,

################################################################################


  # Site-specific additions and overrides. See local/README for details.
  #include <local/usr.sbin.mysqld>
}
